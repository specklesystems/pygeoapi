<html>
  <head>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.2.2/maptiler-sdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.2.2/maptiler-sdk.css" rel="stylesheet" />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>

  <script type="text/javascript">

        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16), parseInt(result[0], 16)] : null;
            };
        function  rgbaToArgbList(color) {
            col = color.replace('rgba(','').replace(')','').split(',',4);
            value = [ parseInt(col[0]), parseInt(col[1]), parseInt(col[2]), parseInt(col[3]) ];
            return value;
            }

        async function initialize() {
            maptilersdk.config.apiKey = 'YOUR_MAPTILER_API_KEY'; 

            var speckle_url = 'https://geo.speckle.systems/?speckleUrl=https://app.speckle.systems/projects/5feae56049/models/9c43d7569c&limit=1000000&datatype=polygons&preserveattributes=false';

            const speckle_data = await fetch(speckle_url, {
                headers: {
                    'Accept': 'application/geo+json'
                }
            }).then(response => response.json());

            
            var speckle_features = []
                for (let i = 0; i < speckle_data.features.length; i++) {
                    feature = speckle_data.features[i];
                    coords = feature.geometry.coordinates;

                    if (feature.geometry.type.includes("Polygon") && speckle_url.toLowerCase().includes('&preserveattributes=false')) {
                        // check orientation of each PolygonPart
                        for (let c = 0; c < coords[0].length; c++) {

                            sum_orientation = 0;
                            polygon_pts = coords[0][c]; // usually 3 for Mesh faces
                            for (let k = 0; k < polygon_pts.length; k++){
                                index = k + 1
                                if (k == polygon_pts.length - 1){index = 0}
                                pt = polygon_pts[k]
                                pt2 = polygon_pts[index]
                                sum_orientation += (pt2[0] - pt[0]) * (pt2[1] + pt[1]) 
                            };
                            if (sum_orientation <0.1 ){
                                coords[0][c][0][0] += 0.000001;
                                coords[0][c][0][1] += 0.000001;
                            };
                        };

                        speckle_data.features[i].geometry.coordinates = coords;
                    } 
                }
        
            // Create deck.gl map
            const deckgl = new deck.DeckGL({
                container: 'map',
                map: maptilersdk,
                mapStyle: maptilersdk.MapStyle.STREETS,
                initialViewState: {
                longitude: 5.4103499188872854,
                latitude: 46.40293137177316,
                zoom: 3.83,
                pitch: 60,
                bearing: 1.469387755102039
                },
                controller: true,

                layers: [
                new deck.GeoJsonLayer({
                    id: 'airports',
                    data: speckle_data,
                    // Styles
                    filled: true,
                    getFillColor: f => rgbaToArgbList(f.properties.color),
                    getLineWidth: 0.05,
                    // Interactive props
                    pickable: true,
                    autoHighlight: true,
                    onClick: info =>
                    // eslint-disable-next-line
                    info.object && alert(`${info.object.properties.speckle_type}: ${info.object.properties.id}`)
                })
                //,
                //new deck.ArcLayer({
                //  id: 'arcs',
                //  data: AIR_PORTS,
                //  dataTransform: d => d.features.filter(f => f.properties.scalerank < 4),
                //  // Styles
                //  getSourcePosition: f => [-0.4531566, 51.4709959], // London
                //  getTargetPosition: f => f.geometry.coordinates,
                //  getSourceColor: [0, 128, 200],
                //  getTargetColor: [200, 0, 80],
                //  getWidth: 1
                //})
                ]
            });
    }

    initialize();
  </script>
</html>