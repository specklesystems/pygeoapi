{% extends "_base.html" %}
{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
{% endblock %}

{% block body %}
  <section id="collection">
    <h3>{% trans %}URL Parameters{% endtrans %}</h3>
    <p>Speckle URL ('speckleurl'): <a href = "{{ data['speckle_url'] }}/">{{ data['speckle_url'] }}</a></p>
    <p>{% trans %}CRS ID ('crsauthid'): {% endtrans %} {{ data['crs_authid'] }}</p>
    <p>{% trans %}Latitide ('lat'): {% endtrans %} {{ data['lat'] }}</p>
    <p>{% trans %}Longitude ('lon'): {% endtrans %} {{ data['lon'] }}</p>
    <p>{% trans %}Angle to True North, in degrees ('northdegrees'): {% endtrans %} {{ data['north_degrees'] }}</p>
    <p>{% trans %}Feature limit ('limit'): {% endtrans %} {{ data['limit'] }}</p>
  </section>
  <section id="items">
    {% if data['features'] %}
    <div class="row">
      <div id="items-map"></div>
    </div>
    
    <div class="row">
      <p> </p>
    </div>
    
    <div class="row">
      <div style="overflow-x: scroll;">
        {% set props = [] %}
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              {% if data.get('uri_field') %}
                {% set uri_field = data.uri_field %}
                <th>{{ uri_field }}</th>
              {% elif data.get('title_field') %}
                {% set title_field = data.title_field %}
                <th>{{ title_field }}</th>
              {% else %}
                <th>id</th>
              {% endif %}

              {% for k in data['features'][0]['properties'].keys() %}
                {% if k not in [data.id_field, data.title_field, data.uri_field, 'extent'] %}
                  {% set props = props.append(k) %}
                  <th>{{ k | striptags }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for ft in data.features %}
              <tr>
                {% if data.get('uri_field') %}
                  {% set uri_field = data.uri_field %}
                  <td data-label="{{ uri_field }}">
                    <a title="{{ ft.properties.get(uri_field) }}">
                      {{ ft.properties.get(uri_field) }}
                    </a>
                  </td>
                {% elif data.get('title_field') %}
                  {% set title_field = data.title_field %}
                  <td data-label="{{ title_field }}">
                    <a title="{{ ft.properties.get(title_field) }}">
                      {{ ft.properties.get(title_field) | string | truncate( 35 ) }}
                    </a>
                  </td>
                {% else %}
                  <td data-label="id">
                    <a title="{{ ft.id }}">
                      {{ ft.id | string | truncate( 12 )  }}
                    </a>
                  </td>
                {% endif %}

                {% for prop in props %}
                  <td data-label="{{ prop }}">
                    {{ ft.properties.get(prop, '') | string | truncate( 35 ) }}
                  </td>
                {% endfor %}

              </tr>
            {% endfor %}
          </tbody>
          </table>
      </div>
    </div>
    {% else %}
    <div class="row">
        <p>{% trans %}No items{% endtrans %}</p>
    </div>
    {% endif %}
    </section>
{% endblock %}

{% block extrafoot %}
{% if data['features'] %}
    <script>
    var map = L.map('items-map').setView([{{ 45 }}, {{ -75 }}], 5);
    map.addLayer(new L.TileLayer(
        '{{ config['server']['map']['url'] }}', {
            maxZoom: 24,
            attribution: '{{ config['server']['map']['attribution'] | safe }}'
        }
    ));
    var geojson_data = {{ data['features'] | to_json | safe }};

    var items = new L.GeoJSON(geojson_data, {
        onEachFeature: function (feature, layer) {
            var url = '{{ data['speckle_project_url'] }}/models/' + feature.id
            var html = '<span><a href="' + url + '">' + {% if data['title_field'] %} feature['properties']['{{ data['title_field'] }}'] {% else %} feature.id {% endif %} + '</a></span>';
            layer.bindPopup(html);
            
            var myFillColor = feature.properties['color'];
            layer.setStyle({
                fillColor: myFillColor,
                fillOpacity: 0.8,
                weight: 0.5
            });
        }
    });


    {% if data['features'][0]['geometry']['type'] == 'Point' %}
    var markers = L.markerClusterGroup({
        disableClusteringAtZoom: 9,
        chunkedLoading: true,
        chunkInterval: 500,
    });
    markers.clearLayers().addLayer(items);
    map.addLayer(markers);
    {% else %}
    map.addLayer(items);
    {% endif %}

    map.fitBounds(items.getBounds());
    </script>
{% endif %}
{% endblock %}
